<!--! DOCTYPE declaration: Defines this document as HTML5 -->
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Krishi Sevak</title>
    <meta name="theme-color" content="#2e7d32">
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body data-theme="light">
    <header>
        <h1>Krishi Sevak</h1>
        <div class="top-actions">
            <button id="themeToggle">ðŸŒ™</button>
            <button id="openVoice">ðŸŽ¤</button>
            <button onclick="location.reload()">â†»</button>
        </div>
    </header>

    <div class="container">
        <div class="grid">
            <aside class="sidebar">
                <div class="card">
                    <nav>
                        <a href="#" id="nav-dashboard" class="active" onclick="showSection('dashboard')">Dashboard</a>
                        <a href="#" id="nav-recommend" onclick="showSection('recommend')">Crop Recommendation</a>
                        <a href="#" id="nav-detect" onclick="showSection('detect')">Disease Detection</a>
                        <a href="#" id="nav-weather" onclick="showSection('weather')">Weather</a>
                        <a href="#" id="nav-mandi" onclick="showSection('mandi')">Mandi Prices</a>
                        <a href="#" id="nav-cropinfo" onclick="showSection('cropinfo')">Crop Information</a>
                        <a href="#" id="nav-fertilizer" onclick="showSection('fertilizer')">Fertilizer</a>
                        <a href="#" id="nav-ai" onclick="showSection('ai')">AI Advice</a>
                    </nav>
                </div>
                <div class="muted">
                    <small>Version 2.0</small>
                </div>
            </aside>

            <main class="content">

                <!-- === SECTION: DASHBOARD === -->
                <section id="section-dashboard" class="card">
                    <h2>Welcome to Krishi Sevak</h2>
                    <p class="muted">Use the left menu to navigate features. Voice assistant uses your browser's microphone.</p>

                    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
                        <div class="card" style="flex:1;min-width:220px">
                            <strong>Quick Actions</strong>
                            <div style="margin-top:8px">
                                <button onclick="showSection('recommend')">Get Crop Recommendation</button>
                            </div>
                        </div>
                        <div class="card" style="flex:1;min-width:220px">
                            <strong>Status</strong>
                            <div id="quick-status" style="margin-top:8px" class="muted">Loading...</div>
                        </div>
                    </div>
                </section>

                <!-- === SECTION: CROP RECOMMENDATION === -->
                <section id="section-recommend" class="card" style="display:none">
                    <h2>Crop Recommendation</h2>
                    <form id="recommend-form">
                        <div class="row">
                            <div>
                                <label>Soil Type</label>
                                <select name="soil" required>
                                    <option value="">Select soil type</option>
                                    <option value="clay">Clay</option>
                                    <option value="sandy">Sandy</option>
                                    <option value="loamy">Loamy</option>
                                </select>
                            </div>
                            <div>
                                <label>Season</label>
                                <select name="season" required>
                                    <option value="">Select season</option>
                                    <option value="kharif">Kharif</option>
                                    <option value="rabi">Rabi</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit">Get Recommendation</button>
                    </form>
                    <div id="recommend-result" class="result-area"></div>
                </section>

                <!-- === SECTION: DISEASE DETECTION === -->
                <section id="section-detect" class="card" style="display:none">
                    <h2>Crop Disease Detection</h2>
                    <div>
                        <label>Upload Leaf Image</label>
                        <input type="file" accept="image/*" id="disease-image">
                        <div id="image-preview" class="img-preview"></div>
                        <button onclick="detectDisease()">Analyze Image</button>
                    </div>
                    <div id="detect-result" class="result-area"></div>
                </section>

                <!-- === SECTION: WEATHER === -->
                <section id="section-weather" class="card" style="display:none">
                    <h2>Weather Information</h2>
                    <div style="margin-bottom: 16px;">
                        <label for="city-select">Select City</label>
                        <select id="city-select" onchange="loadWeatherData(this.value)">
                            <option value="Agra" selected>Agra</option>
                            <option value="Delhi">Delhi</option>
                            <option value="Mumbai">Mumbai</option>
                            <option value="Bengaluru">Bengaluru</option>
                            <option value="Chennai">Chennai</option>
                            <option value="Kolkata">Kolkata</option>
                            <option value="Hyderabad">Hyderabad</option>
                            <option value="Pune">Pune</option>
                        </select>
                    </div>

                    <div id="weather-data">
                        <div class="row" style="align-items: center;">
                            <div style="flex:1">
                                <h3 id="weather-city">Agra</h3>
                                <div style="font-size: 2em; font-weight: 500;" id="weather-temp">--Â°C</div>
                                <div id="weather-condition">Loading...</div>
                            </div>
                        </div>
                        <div style="margin-top:16px">
                            <h4>Forecast</h4>
                            <div id="forecast-container" style="display: flex; gap: 12px; overflow-x: auto; padding: 8px 0;"></div>
                        </div>
                    </div>
                </section>

                <!-- === SECTION: MANDI PRICES === -->
                <section id="section-mandi" class="card" style="display:none">
                    <h2>Mandi Prices</h2>
                    <div id="mandi-location" class="muted">Data from 10 major cities | <span class="source">AGMARKNET</span></div>
                    <div style="margin-top:16px">
                        <table style="width:100%">
                            <thead>
                                <tr>
                                    <th>Commodity</th>
                                    <th>City</th>
                                    <th>Price (â‚¹)</th>
                                    <th>Unit</th>
                                    <th>Variety</th>
                                </tr>
                            </thead>
                            <tbody id="mandi-prices">
                                <tr><td colspan="5">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- === SECTION: CROP INFORMATION === -->
                <section id="section-cropinfo" class="card" style="display:none">
                    <h2>Crop Information</h2>
                    <div>
                        <label>Select Crop</label>
                        <select id="crop-select" onchange="showCropInfo()">
                            <option value="">Select a crop</option>
                            <option value="wheat">Wheat</option>
                            <option value="rice">Rice</option>
                            <option value="corn">Corn</option>
                            <option value="sugarcane">Sugarcane</option>
                            <option value="cotton">Cotton</option>
                            <option value="soybean">Soybean</option>
                            <option value="mustard">Mustard</option>
                            <option value="groundnut">Groundnut</option>
                            <option value="potato">Potato</option>
                            <option value="tomato">Tomato</option>
                            <option value="onion">Onion</option>
                            <option value="chilli">Chilli</option>
                            <option value="brinjal">Brinjal</option>
                            <option value="cabbage">Cabbage</option>
                            <option value="cauliflower">Cauliflower</option>
                            <option value="carrot">Carrot</option>
                            <option value="beetroot">Beetroot</option>
                            <option value="radish">Radish</option>
                            <option value="bittergourd">Bitter Gourd</option>
                            <option value="papaya">Papaya</option>
                        </select>
                    </div>
                    <div id="crop-info" style="margin-top:16px"></div>
                </section>

                <!-- === SECTION: FERTILIZER RECOMMENDATION === -->
                <section id="section-fertilizer" class="card" style="display:none">
                    <h2>Fertilizer Recommendation</h2>
                    <form id="fertilizer-form">
                        <div>
                            <label>Selected Crop</label>
                            <select name="crop" required>
                                <option value="wheat">Wheat</option>
                                <option value="rice">Rice</option>
                                <option value="corn">Corn</option>
                                <option value="sugarcane">Sugarcane</option>
                                <option value="cotton">Cotton</option>
                                <option value="soybean">Soybean</option>
                                <option value="mustard">Mustard</option>
                                <option value="groundnut">Groundnut</option>
                                <option value="potato">Potato</option>
                                <option value="tomato">Tomato</option>
                                <option value="onion">Onion</option>
                                <option value="chilli">Chilli</option>
                                <option value="brinjal">Brinjal</option>
                                <option value="cabbage">Cabbage</option>
                                <option value="cauliflower">Cauliflower</option>
                                <option value="carrot">Carrot</option>
                                <option value="beetroot">Beetroot</option>
                                <option value="radish">Radish</option>
                                <option value="bittergourd">Bitter Gourd</option>
                                <option value="papaya">Papaya</option>
                            </select>
                        </div>
                        <button type="submit">Get Recommendation</button>
                    </form>
                    <div id="fertilizer-result" class="result-area"></div>
                </section>

                <!-- === SECTION: AI FARMING ASSISTANT (CHATBOT) === -->
                <section id="section-ai" class="card" style="display:none">
                    <h2>AI Farming Assistant</h2>
                    <div style="background: var(--background); border-radius: 8px; padding: 12px; min-height: 200px; max-height: 300px; overflow-y: auto;" id="chat-history"></div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <input type="text" id="chat-input" placeholder="Ask about farming, weather, prices..." style="flex:1; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                        <button onclick="sendChatMessage()" style="min-width: 80px;">Send</button>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <footer>Â© 2025 Krishi Sevak â€¢ Empowering Indian farmers with technology</footer>

    <script src="/static/js/app.js"></script>

    <!-- === LLAMA 3 AI CHATBOT SCRIPT === -->
    <script>
    const HF_TOKEN = "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";
    const MODEL = "meta-llama/Llama-3-8b-chat-hf";

    async function sendChatMessage() {
        const inputBox = document.getElementById("chat-input");
        const chatHistory = document.getElementById("chat-history");
        const userMessage = inputBox.value.trim();
        if (!userMessage) return;

        const userDiv = document.createElement("div");
        userDiv.innerHTML = `<strong>You:</strong> ${userMessage}`;
        chatHistory.appendChild(userDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        inputBox.value = "";

        const aiDiv = document.createElement("div");
        aiDiv.innerHTML = `<em>AI is thinking...</em>`;
        chatHistory.appendChild(aiDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;

        try {
            const response = await fetch(`https://api-inference.huggingface.co/models/${MODEL}`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${HF_TOKEN}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    inputs: userMessage,
                    parameters: { max_new_tokens: 200, temperature: 0.7 }
                }),
            });

            const data = await response.json();
            let aiMessage = data[0]?.generated_text || data.generated_text || "No response from AI.";
            aiMessage = aiMessage.replace(userMessage, "").trim();

            aiDiv.innerHTML = `<strong>AI:</strong> ${aiMessage}`;
        } catch (error) {
            aiDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
        }

        chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    </script>
</body>
</html>
