<!DOCTYPE html>
<html lang="en">
<head>
    <!-- === META TAGS === -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#2e7d32">
    
    <!-- === PAGE TITLE === -->
    <title>Krishi Sevak - Smart Farming Platform</title>
    
    <!-- === PWA MANIFEST === -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- === FONTS === -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- === EXTERNAL CSS FILE === -->
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body data-theme="light">
    <!-- ========================================
         HEADER SECTION
         Contains: Logo, Theme Toggle, Voice, Refresh
    ======================================== -->
    <header>
        <h1>🌾 Krishi Sevak</h1>
        <div class="top-actions">
            <button id="themeToggle" title="Toggle Theme">🌙</button>
            <button id="openVoice" title="Voice Assistant">🎤</button>
            <button onclick="location.reload()" title="Refresh">↻</button>
        </div>
    </header>

    <!-- ========================================
         MAIN CONTAINER
    ======================================== -->
    <div class="container">
        <div class="grid">
            
            <!-- === SIDEBAR NAVIGATION === -->
            <aside class="sidebar">
                <div class="card">
                    <nav>
                        <!-- Navigation items ordered by priority -->
                        <a href="#" id="nav-dashboard" class="active" onclick="showSection('dashboard')">🏠 Dashboard</a>
                        <a href="#" id="nav-recommend" onclick="showSection('recommend')">🌱 Crop Recommendation</a>
                        <a href="#" id="nav-detect" onclick="showSection('detect')">🔬 Disease Detection</a>
                        <a href="#" id="nav-weather" onclick="showSection('weather')">🌤️ Weather</a>
                        <a href="#" id="nav-mandi" onclick="showSection('mandi')">💰 Mandi Prices</a>
                        <a href="#" id="nav-fertilizer" onclick="showSection('fertilizer')">🧪 Fertilizer</a>
                        <a href="#" id="nav-cropinfo" onclick="showSection('cropinfo')">📚 Crop Information</a>
                        <a href="#" id="nav-ai" onclick="showSection('ai')">🤖 AI Assistant</a>
                    </nav>
                </div>
                <div class="muted">
                    <small>Version 2.0 • <span class="status-badge online">Online</span></small>
                </div>
            </aside>

            <!-- ========================================
                 MAIN CONTENT AREA
            ======================================== -->
            <main class="content">

                <!-- ========================================
                     SECTION: DASHBOARD (HOME)
                     Priority: Highest
                     Shows: Welcome, Quick Actions, Feature Cards
                ======================================== -->
                <section id="section-dashboard" class="card">
                    <!-- Hero Section -->
                    <div class="hero-section">
                        <h2>Welcome to Krishi Sevak</h2>
                        <p>Your intelligent farming companion powered by AI and real-time data</p>
                    </div>

                    <!-- Quick Status Info -->
                    <div class="status-container">
                        <strong>System Status:</strong>
                        <div id="quick-status">All services operational ✓</div>
                    </div>

                    <!-- Feature Cards Grid (Top Priority Features) -->
                    <h3 class="section-subtitle">🌟 Core Features</h3>
                    <div class="feature-grid">
                        <!-- Feature 1: Crop Recommendation (Priority 1) -->
                        <div class="feature-card" onclick="showSection('recommend')">
                            <span class="icon">🌱</span>
                            <h3>Crop Recommendation</h3>
                            <p>Get AI-powered suggestions based on your soil type and season for optimal yield.</p>
                        </div>

                        <!-- Feature 2: Disease Detection (Priority 2) -->
                        <div class="feature-card" onclick="showSection('detect')">
                            <span class="icon">🔬</span>
                            <h3>Disease Detection</h3>
                            <p>Upload leaf images for instant disease identification and treatment advice.</p>
                        </div>

                        <!-- Feature 3: Weather Forecast (Priority 3) -->
                        <div class="feature-card" onclick="showSection('weather')">
                            <span class="icon">🌤️</span>
                            <h3>Weather Forecast</h3>
                            <p>Real-time weather updates and forecasts for better farming decisions.</p>
                        </div>

                        <!-- Feature 4: Mandi Prices (Priority 4) -->
                        <div class="feature-card" onclick="showSection('mandi')">
                            <span class="icon">💰</span>
                            <h3>Mandi Prices</h3>
                            <p>Live commodity prices from major markets across India via AGMARKNET.</p>
                        </div>

                        <!-- Feature 5: Fertilizer Recommendation -->
                        <div class="feature-card" onclick="showSection('fertilizer')">
                            <span class="icon">🧪</span>
                            <h3>Fertilizer Guide</h3>
                            <p>Personalized fertilizer recommendations for your selected crops.</p>
                        </div>

                        <!-- Feature 6: AI Assistant -->
                        <div class="feature-card" onclick="showSection('ai')">
                            <span class="icon">🤖</span>
                            <h3>AI Assistant</h3>
                            <p>Ask farming questions and get instant answers powered by Llama 3 AI.</p>
                        </div>
                    </div>
                </section>

                <!-- ========================================
                     SECTION: CROP RECOMMENDATION
                     Priority: 1 (Top Feature)
                     Input: Soil type, Season
                     Output: Recommended crops
                ======================================== -->
                <section id="section-recommend" class="card priority-section" style="display:none">
                    <h2>🌱 Crop Recommendation</h2>
                    <p class="muted">Get personalized crop suggestions based on your soil and season</p>
                    
                    <form id="recommend-form">
                        <div class="row">
                            <!-- Soil Type Input -->
                            <div>
                                <label>Soil Type</label>
                                <select name="soil" required>
                                    <option value="">Select soil type</option>
                                    <option value="clay">Clay Soil</option>
                                    <option value="sandy">Sandy Soil</option>
                                    <option value="loamy">Loamy Soil</option>
                                    <option value="black">Black Soil</option>
                                    <option value="red">Red Soil</option>
                                </select>
                            </div>
                            
                            <!-- Season Input -->
                            <div>
                                <label>Season</label>
                                <select name="season" required>
                                    <option value="">Select season</option>
                                    <option value="kharif">Kharif (June-Oct)</option>
                                    <option value="rabi">Rabi (Nov-Mar)</option>
                                    <option value="zaid">Zaid (Mar-June)</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit">Get Recommendation</button>
                    </form>
                    
                    <!-- Result Display Area -->
                    <div id="recommend-result" class="result-area"></div>
                </section>

                <!-- ========================================
                     SECTION: DISEASE DETECTION
                     Priority: 2
                     Input: Leaf image upload
                     Output: Disease identification + treatment
                ======================================== -->
                <section id="section-detect" class="card priority-section" style="display:none">
                    <h2>🔬 Crop Disease Detection</h2>
                    <p class="muted">Upload a clear image of the affected leaf for AI-powered disease diagnosis</p>
                    
                    <div class="upload-container">
                        <label>Upload Leaf Image</label>
                        <input type="file" accept="image/*" id="disease-image">
                        
                        <!-- Image Preview Area -->
                        <div id="image-preview" class="img-preview"></div>
                        
                        <button onclick="detectDisease()" class="btn-analyze">
                            Analyze Image
                        </button>
                    </div>
                    
                    <!-- Detection Result Area -->
                    <div id="detect-result" class="result-area"></div>
                </section>

                <!-- ========================================
                     SECTION: WEATHER INFORMATION
                     Priority: 3
                     Shows: Current weather + 5-day forecast
                     Data Source: Weather API
                ======================================== -->
                <section id="section-weather" class="card" style="display:none">
                    <h2>🌤️ Weather Information</h2>
                    <p class="muted">Real-time weather data and forecasts for farming decisions</p>
                    
                    <!-- City Selection -->
                    <div class="city-selector">
                        <label for="city-select">Select City</label>
                        <select id="city-select" onchange="loadWeatherData(this.value)">
                            <option value="Agra" selected>Agra</option>
                            <option value="Delhi">Delhi</option>
                            <option value="Mumbai">Mumbai</option>
                            <option value="Bengaluru">Bengaluru</option>
                            <option value="Chennai">Chennai</option>
                            <option value="Kolkata">Kolkata</option>
                            <option value="Hyderabad">Hyderabad</option>
                            <option value="Pune">Pune</option>
                            <option value="Jaipur">Jaipur</option>
                            <option value="Lucknow">Lucknow</option>
                        </select>
                    </div>

                    <!-- Current Weather Display -->
                    <div id="weather-data" class="weather-display">
                        <div class="row">
                            <div class="weather-main">
                                <h3 id="weather-city">Agra</h3>
                                <div class="temperature" id="weather-temp">--°C</div>
                                <div id="weather-condition">Loading weather data...</div>
                            </div>
                        </div>
                        
                        <!-- 5-Day Forecast -->
                        <div class="forecast-section">
                            <h4>5-Day Forecast</h4>
                            <div id="forecast-container" class="forecast-grid"></div>
                        </div>
                    </div>
                </section>

                <!-- ========================================
                     SECTION: MANDI PRICES
                     Priority: 4
                     Shows: Live commodity prices from AGMARKNET
                     Data: 10+ major cities
                ======================================== -->
                <section id="section-mandi" class="card" style="display:none">
                    <h2>💰 Mandi Prices</h2>
                    <div id="mandi-location" class="muted">
                        Live data from 10+ major cities | Source: <span class="source">AGMARKNET</span>
                    </div>
                    
                    <!-- Prices Table -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Commodity</th>
                                    <th>City</th>
                                    <th>Price (₹)</th>
                                    <th>Unit</th>
                                    <th>Variety</th>
                                </tr>
                            </thead>
                            <tbody id="mandi-prices">
                                <tr><td colspan="5" class="loading-cell">Loading mandi prices...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- ========================================
                     SECTION: FERTILIZER RECOMMENDATION
                     Priority: 5
                     Input: Crop selection
                     Output: Fertilizer recommendations
                ======================================== -->
                <section id="section-fertilizer" class="card" style="display:none">
                    <h2>🧪 Fertilizer Recommendation</h2>
                    <p class="muted">Get optimal fertilizer suggestions for your selected crop</p>
                    
                    <form id="fertilizer-form">
                        <div>
                            <label>Select Crop</label>
                            <select name="crop" required>
                                <option value="">Choose a crop</option>
                                <!-- Cereals -->
                                <optgroup label="Cereals">
                                    <option value="wheat">Wheat</option>
                                    <option value="rice">Rice</option>
                                    <option value="corn">Corn</option>
                                </optgroup>
                                <!-- Cash Crops -->
                                <optgroup label="Cash Crops">
                                    <option value="sugarcane">Sugarcane</option>
                                    <option value="cotton">Cotton</option>
                                </optgroup>
                                <!-- Pulses & Oilseeds -->
                                <optgroup label="Pulses & Oilseeds">
                                    <option value="soybean">Soybean</option>
                                    <option value="mustard">Mustard</option>
                                    <option value="groundnut">Groundnut</option>
                                </optgroup>
                                <!-- Vegetables -->
                                <optgroup label="Vegetables">
                                    <option value="potato">Potato</option>
                                    <option value="tomato">Tomato</option>
                                    <option value="onion">Onion</option>
                                    <option value="chilli">Chilli</option>
                                    <option value="brinjal">Brinjal</option>
                                    <option value="cabbage">Cabbage</option>
                                    <option value="cauliflower">Cauliflower</option>
                                    <option value="carrot">Carrot</option>
                                    <option value="beetroot">Beetroot</option>
                                    <option value="radish">Radish</option>
                                    <option value="bittergourd">Bitter Gourd</option>
                                </optgroup>
                                <!-- Fruits -->
                                <optgroup label="Fruits">
                                    <option value="papaya">Papaya</option>
                                </optgroup>
                            </select>
                        </div>
                        <button type="submit">Get Fertilizer Recommendation</button>
                    </form>
                    
                    <!-- Result Display Area -->
                    <div id="fertilizer-result" class="result-area"></div>
                </section>

                <!-- ========================================
                     SECTION: CROP INFORMATION DATABASE
                     Priority: 6
                     Shows: Comprehensive crop details
                     Data: 20+ crops
                ======================================== -->
                <section id="section-cropinfo" class="card" style="display:none">
                    <h2>📚 Crop Information Database</h2>
                    <p class="muted">Detailed information about various crops including cultivation practices</p>
                    
                    <div class="crop-selector">
                        <label>Select Crop</label>
                        <select id="crop-select" onchange="showCropInfo()">
                            <option value="">Select a crop to view details</option>
                            <!-- Cereals -->
                            <optgroup label="Cereals">
                                <option value="wheat">Wheat</option>
                                <option value="rice">Rice</option>
                                <option value="corn">Corn</option>
                            </optgroup>
                            <!-- Cash Crops -->
                            <optgroup label="Cash Crops">
                                <option value="sugarcane">Sugarcane</option>
                                <option value="cotton">Cotton</option>
                            </optgroup>
                            <!-- Pulses & Oilseeds -->
                            <optgroup label="Pulses & Oilseeds">
                                <option value="soybean">Soybean</option>
                                <option value="mustard">Mustard</option>
                                <option value="groundnut">Groundnut</option>
                            </optgroup>
                            <!-- Vegetables -->
                            <optgroup label="Vegetables">
                                <option value="potato">Potato</option>
                                <option value="tomato">Tomato</option>
                                <option value="onion">Onion</option>
                                <option value="chilli">Chilli</option>
                                <option value="brinjal">Brinjal</option>
                                <option value="cabbage">Cabbage</option>
                                <option value="cauliflower">Cauliflower</option>
                                <option value="carrot">Carrot</option>
                                <option value="beetroot">Beetroot</option>
                                <option value="radish">Radish</option>
                                <option value="bittergourd">Bitter Gourd</option>
                            </optgroup>
                            <!-- Fruits -->
                            <optgroup label="Fruits">
                                <option value="papaya">Papaya</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <!-- Crop Information Display Area -->
                    <div id="crop-info" class="crop-info-display"></div>
                </section>

                <!-- ========================================
                     SECTION: AI FARMING ASSISTANT (CHATBOT)
                     Priority: 7
                     Uses: Llama 3 via Hugging Face API
                     Features: Natural language Q&A
                ======================================== -->
                <section id="section-ai" class="card" style="display:none">
                    <h2>🤖 AI Farming Assistant</h2>
                    <p class="muted">Ask questions about farming, weather, prices, or get advice - powered by Llama 3 AI</p>
                    
                    <!-- Chat History Display -->
                    <div id="chat-history" class="chat-container">
                        <div class="chat-placeholder">
                            Start a conversation by typing your question below...
                        </div>
                    </div>
                    
                    <!-- Chat Input Area -->
                    <div class="chat-input-container">
                        <input 
                            type="text" 
                            id="chat-input" 
                            placeholder="Ask about farming, weather, crop diseases, prices..." 
                            onkeypress="if(event.key === 'Enter') sendChatMessage()"
                        >
                        <button onclick="sendChatMessage()" class="btn-send">
                            Send
                        </button>
                    </div>
                    
                    <div class="muted chat-tip">
                        💡 Tip: Ask specific questions for better responses
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- ========================================
         FOOTER
    ======================================== -->
    <footer>
        © 2025 Krishi Sevak • Empowering Indian farmers with technology 🇮🇳
    </footer>

    <!-- ========================================
         EXTERNAL JAVASCRIPT
         Main app logic from app.js
    ======================================== -->
    <script src="/static/js/app.js"></script>

    <!-- ========================================
         AI CHATBOT INTEGRATION
         Uses: Hugging Face Inference API
         Model: Llama 3 8B Chat
    ======================================== -->
    <script>
        // === HUGGING FACE API CONFIGURATION ===
        const HF_TOKEN = "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";
        const MODEL = "meta-llama/Llama-3-8b-chat-hf";

        /**
         * Send user message to Llama 3 AI and display response
         * Handles: User input, API call, response parsing, error handling
         */
        async function sendChatMessage() {
            // Get DOM elements
            const inputBox = document.getElementById("chat-input");
            const chatHistory = document.getElementById("chat-history");
            const userMessage = inputBox.value.trim();
            
            // Validate input
            if (!userMessage) return;

            // Clear placeholder if present
            const placeholder = chatHistory.querySelector('.chat-placeholder');
            if (placeholder) {
                chatHistory.innerHTML = '';
            }

            // Display user message
            const userDiv = document.createElement("div");
            userDiv.className = "chat-message user-message";
            userDiv.innerHTML = `<strong>You:</strong> ${userMessage}`;
            chatHistory.appendChild(userDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // Clear input
            inputBox.value = "";

            // Show loading indicator
            const aiDiv = document.createElement("div");
            aiDiv.className = "chat-message ai-message";
            aiDiv.innerHTML = `<em class="loading-text">🤔 AI is thinking...</em>`;
            chatHistory.appendChild(aiDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                // Call Hugging Face API
                const response = await fetch(`https://api-inference.huggingface.co/models/${MODEL}`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${HF_TOKEN}`,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        inputs: userMessage,
                        parameters: { 
                            max_new_tokens: 250, 
                            temperature: 0.7,
                            top_p: 0.9,
                            repetition_penalty: 1.2
                        }
                    }),
                });

                // Parse response
                const data = await response.json();
                let aiMessage = data[0]?.generated_text || data.generated_text || "I couldn't generate a response. Please try again.";
                
                // Clean up response (remove echo of user message)
                aiMessage = aiMessage.replace(userMessage, "").trim();

                // Display AI response
                aiDiv.innerHTML = `<strong>🤖 AI Assistant:</strong><br><span class="ai-response-text">${aiMessage}</span>`;
                
            } catch (error) {
                // Handle errors
                aiDiv.className = "chat-message error-message";
                aiDiv.innerHTML = `<strong>⚠️ Error:</strong><br><span>${error.message}</span>`;
            }

            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // === AUTO-LOAD FUNCTIONS ON PAGE LOAD ===
        document.addEventListener('DOMContentLoaded', function() {
            // Load weather data for default city
            if (typeof loadWeatherData === 'function') {
                loadWeatherData('Agra');
            }
            
            // Initialize any other required features
            console.log('Krishi Sevak initialized successfully');
        });
    </script>
</body>
</html>
